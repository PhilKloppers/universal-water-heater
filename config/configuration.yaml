# yaml-language-server: $schema=../schemas/yaml/configuration_schema.yaml
# Development-friendly Home Assistant configuration
#
# We don't use default_config to avoid HA OS-specific integrations like go2rtc
# that expect specific container environments. Instead, we explicitly load
# the integrations useful for custom component development.

# https://www.home-assistant.io/integrations/homeassistant/
homeassistant:
  debug: true

# Debugging integration
# https://www.home-assistant.io/integrations/debugpy/
debugpy:

# Privacy & analytics settings
# https://www.home-assistant.io/integrations/analytics/
analytics:
  # Analytics are disabled to prevent development instances from skewing
  # production statistics at https://analytics.home-assistant.io

# System monitoring
# https://www.home-assistant.io/integrations/system_health/
system_health:
  # Provides system health information in Settings > System > Repairs
  # Safe for development - only shows local system status

# Note: The diagnostics integration is always loaded and cannot be disabled.
# With analytics disabled, diagnostic data stays local and isn't sent anywhere.

# Core integrations
http:
  # Development server settings for Codespaces/DevContainer
  # Allow access from Codespaces reverse proxy
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.0/8
    - ::1
    - 192.168.0.0/16
    - 172.16.0.0/12
    - 10.0.0.0/8
  # CORS for development
  cors_allowed_origins:
    - "*"

# Config UI integration - useful for development
config:

# Frontend - required for UI
frontend:
  # Optional: Enable custom themes
  # themes: !include_dir_merge_named themes

automation:
  # Periodic evaluation - Run control logic every 1 minute for responsive control
  - alias: "Universal Water Heater - Periodic Control Logic"
    id: universal_water_heater_periodic_control
    description: "Evaluate temperature control logic every minute for responsive control"
    trigger:
      - platform: time_pattern
        minutes: "/1"  # Every 1 minute for responsive control
    action:
      - service: universal_water_heater.evaluate_control_logic
        data: {}
    mode: single
    max_exceeded: silent

  # Temperature simulation - Increase when heater is on, decrease when off
  - alias: "Temperature Simulator"
    id: temperature_simulator
    description: "Simulate temperature changes based on heater relay state"
    trigger:
      - platform: time_pattern
        seconds: "/1"  # Every 1 second
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: switch.heater_relay
                state: "on"
            sequence:
              - service: input_number.increment
                target:
                  entity_id: input_number.temperature
          - conditions:
              - condition: state
                entity_id: switch.heater_relay
                state: "off"
            sequence:
              - service: input_number.decrement
                target:
                  entity_id: input_number.temperature
    mode: single

script:

scene:

# Useful default_config integrations for development
# https://www.home-assistant.io/integrations/history/
history:

# https://www.home-assistant.io/integrations/logbook/
logbook:

# https://www.home-assistant.io/integrations/conversation/
# conversation:
# Note: Uncomment to enable voice assistant/conversation features
# Dependencies (hassil, home-assistant-intents) are pre-installed in bootstrap

# https://www.home-assistant.io/integrations/webhook/
webhook:

# https://www.home-assistant.io/integrations/my/
my:

# https://www.home-assistant.io/integrations/recorder/
recorder:
  # Development-friendly database settings
  # Reduce database size and improve performance
  purge_keep_days: 2
  commit_interval: 30
  # Exclude entities you don't need history for
  exclude:
    domains:
      # Sun position changes constantly, rarely needed in dev
      - sun
      # Backups don't need history
      - backup
      # Updates don't need full history tracking
      - update
    entity_globs:
      # Time sensors change every second/minute
      - sensor.time*
      - sensor.date*
      # Uptime sensors not interesting for development
      - sensor.*uptime*
      - sensor.*last_boot*
      # Memory/CPU sensors create a lot of data
      - sensor.*memory*
      - sensor.*cpu*
    event_types:
      # Very frequent, rarely needed in development
      - call_service
      # System events create lots of noise
      - system_log_event
      # Component loading events
      - component_loaded

# https://www.home-assistant.io/integrations/logger/
logger:
  default: info
  logs:
    # Reduce noise from chatty components
    homeassistant.components.recorder: warning
    homeassistant.components.recorder.util: warning
    homeassistant.components.websocket_api: warning
    homeassistant.components.http.ban: warning
    homeassistant.components.zeroconf: warning
    homeassistant.components.ssdp: warning
    homeassistant.components.bluetooth: warning
    # Conversation can be noisy with hassil
    homeassistant.components.conversation: warning
    # Analytics/metrics are not interesting during development
    homeassistant.components.analytics: error

    # Hide platform setup messages (scene, binary_sensor, sensor, etc.)
    homeassistant.components.scene: warning
    homeassistant.components.binary_sensor: warning
    homeassistant.components.sensor: warning
    homeassistant.components.event: warning
    homeassistant.components.switch: warning

    # HTTP/network
    homeassistant.components.http: warning

    # Keep loader at warning level to see real issues with our integration
    homeassistant.loader: warning

    # Hide the verbose "Setting up X" messages during startup
    # but keep warnings/errors visible
    homeassistant.bootstrap: warning
    homeassistant.setup: warning

    # Core system - keep visible for important messages
    homeassistant.core: info

    # IMPORTANT for custom integration development:
    # Coordinator issues (API calls, update failures)
    homeassistant.helpers.update_coordinator: info
    # Entity registration problems
    homeassistant.helpers.entity_registry: info
    # Config flow debugging (setup, options)
    homeassistant.config_entries: info

    # Your integration debug logging - shows EVERYTHING from your integration
    custom_components.universal_water_heater: debug

input_number:
  temperature:
    name: temperature
    icon: "mdi:settings-helper"
    initial: 50
    min: 20
    max: 100
    step: 0.1
  battery_soc:
    name: battery_soc
    icon: "mdi:settings-helper"
    initial: 50
    min: 0
    max: 100
    step: 0.1

input_boolean:
  relay_helper:
    name: "Heater Relay Helper"
    initial: on
    icon: "mdi:settings-helper"

template:
  - sensor:
      - name: "Power"
        unique_id: "power_sensor"
        icon: "mdi:code-brackets"
        unit_of_measurement: "W"
        state: >
          {{ states('sensor.time').split(':')[1]|int * 10 }}
      - name: "Voltage"
        unique_id: "voltage_sensor"
        icon: "mdi:code-brackets"
        unit_of_measurement: "V"
        state: "225"
      - name: "Current"
        unique_id: "current_sensor"
        icon: "mdi:code-brackets"
        unit_of_measurement: "A"
        state: >
          {{ states('sensor.power')|float / states('sensor.voltage')|float | round(2) }}
      - name: "Temperature"
        unique_id: "temperature_sensor"
        icon: "mdi:code-brackets"
        unit_of_measurement: "Â°C"
        state: >
          {{ (states('input_number.temperature'))|float(0) }}
      - name: "Battery SOC"
        unique_id: "battery_soc_sensor"
        icon: "mdi:code-brackets"
        unit_of_measurement: "%"
        device_class: "battery"
        state: >
          {{ (states('input_number.battery_soc'))|float(0) }}
  - switch:
      - name: "Heater Relay"
        unique_id: "heater_relay_switch"
        icon: "mdi:code-brackets"
        state: >
          {{ is_state('input_boolean.relay_helper', 'on') }}
        turn_on:
          service: input_boolean.turn_on
          target:
            entity_id: input_boolean.relay_helper
        turn_off:
          service: input_boolean.turn_off
          target:
            entity_id: input_boolean.relay_helper
